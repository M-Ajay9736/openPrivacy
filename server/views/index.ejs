<!doctype html>
<html lang="en">

<head>
  <!-- Hashing Algorithm -->
  <script src="core.js"></script>
  <script src="sha256.js"></script>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>Cool App</title>
</head>

<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Get Priv(Beta)</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home<span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="loginAnchor" href="" data-toggle="modal" data-target="#loginModal">Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="regAnchor" href="" data-toggle="modal" data-target="#registerModal">Register</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Donate</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="" data-toggle="modal" data-target="#exampleModal">Password Recovery</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="bd-example">
      <div id="carouselExampleCaptions" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          <li data-target="#carouselExampleCaptions" data-slide-to="0" class="active"></li>
          <li data-target="#carouselExampleCaptions" data-slide-to="1"></li>
          <li data-target="#carouselExampleCaptions" data-slide-to="2"></li>
        </ol>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="slider1.jpeg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block bg-primary">
              <h5>First slide label</h5>
              <p>Nulla vitae elit libero, a pharetra augue mollis interdum.</p>
            </div>
          </div>
          <div class="carousel-item">
            <img src="slider2.jpeg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block bg-primary">
              <h5>Second slide label</h5>
              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
            </div>
          </div>
          <div class="carousel-item">
            <img src="slider3.jpeg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block bg-primary">
              <h5>Third slide label</h5>
              <p>Praesent commodo cursus magna, vel scelerisque nisl consectetur.</p>
            </div>
          </div>
        </div>
        <a class="carousel-control-prev" href="#carouselExampleCaptions" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleCaptions" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
    </div>
  </header>
  <!-- login modal section start-->
  <section>
    <div class="modal" tabindex="-1" role="dialog" id="loginModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Log In</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="form-group">
                <label for="inputEmail1">Email address</label>
                <input type="email" class="form-control" id="inputEmail1" aria-describedby="emailHelp"
                  placeholder="Enter email" required="true">
              </div>
              <div class="form-group">
                <label for="inputPassword1">Password</label>
                <input type="password" class="form-control" id="inputPassword1" placeholder="Password" required="true">
              </div>
              <div class="form-group form-check">
                <span id="error"></span>
              </div>
              <button type="submit" id="in-btn" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- login modal section end -->
  <!-- register modal section start-->
  <section>
    <div class="modal" tabindex="-1" role="dialog" id="registerModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Register</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="regForm">
              <div class="form-group">
                <label for="inputName2">Enter name</label>
                <input type="text" class="form-control" id="inputName2" placeholder="Tony Stark" required="true">
              </div>
              <div class="form-group">
                <label for="inputEmail2">Email address</label>
                <input type="email" class="form-control" id="inputEmail2" aria-describedby="emailHelp"
                  placeholder="tony@gmail.com" required="true">
              </div>
              <div class="form-group">
                <label for="inputPassword2">Password</label>
                <input type="password" class="form-control" id="inputPassword2" placeholder="tony1234" required="true">
              </div>
              <div class="form-group">
                <label for="inputConfirmPassword2">Confirm Password</label>
                <input type="password" class="form-control" id="inputConfirmPassword2" placeholder="tony1234"
                  required="true">
              </div>
              <div class="form-group form-check">
                <input type="checkbox" class="form-check-input" id="inputCheck2">
                <label class="form-check-label" for="inputCheck2">I always forget passwords<p class="text-warning">
                    (Unsafe: will backup your password into a file so that you can use it when needed)</p></label>
              </div>
              <div class="form-group form-check">
                <span id="rerror"></span>
              </div>
              <button type="submit" id="up-btn" class="btn btn-primary">Register</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- register modal section end-->
  <!-- recovery modal section-->
  <section>
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Password Recovery</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="inputEmail3">Email address</label>
                <input type="email" class="form-control" id="inputEmail3" aria-describedby="emailHelp"
                  placeholder="tony@starkindustries.com" required="true">
              </div>
              <div class="form-group">
                <label for="exampleFormControlFile1">Upload 'secret_keep_me_safe' file</label>
                <input type="file" class="form-control-file" id="exampleFormControlFile1">
              </div>
              <div class="col-sm-12">
                <input type="text" readonly class="form-control-plaintext" id="staticPassword" value="">
              </div>
              <div class="col-sm-11">
                <input type="text" readonly class="form-control-plaintext" id="staticMessage"
                  value="We don't send this file to server so sit back and relax!">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- recovery modal section end-->
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script type="text/javascript" src="bower_components/crypto-js/crypto-js.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      if (localStorage.getItem('name')) {
        $("#loginAnchor").text(localStorage.getItem('name'))
        $("#regAnchor").remove()
        $("#loginModal").remove()
        $("#loginAnchor").click(function () {
          window.location = '/dashboard'
        })
      }
      function downloadBackup(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }
      //document.documentElement.innerHTML = '<h1>REplaced</h1>'
      let url = 'http://localhost:3000', localUrl = 'http://localhost:5000'  //Globals
      //Hash Function
      function generateHash(plainText) {
        var hashText = CryptoJS.SHA256(plainText)
        return hashText.toString()
      }
      //Hash Function End
      let fetchOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      }
      $("#regForm").submit(function (e) {
        e.preventDefault()
        $('#rerror').html(' ')
        if ($('#inputPassword2').val().length < 8) {
          $('#rerror').html("<p class='text-danger'>Password must be greater then 7 characters</p>")
          return
        }
        let data = {
          name: $('#inputName2').val(),
          email: $('#inputEmail2').val(),
          password: generateHash($('#inputPassword2').val()),
          checked: document.getElementById('inputCheck2').checked
        }
        let copy = fetchOptions
        copy.body = JSON.stringify(data)
        fetch(url + "/signup", copy).then(function (response) {
          if (response.status !== 200) {
            console.log('Something wrong Response Status: ' + response.status)
            return
          }
          response.json().then(function (data) {
            if (data.msg == 'Success') {
              //window.location = '/'
              if (document.getElementById('inputCheck2').checked) {
                downloadBackup('secret_keep_me_safe', JSON.stringify({ info: 'Use if password lost', cipher: CryptoJS.AES.encrypt($('#inputPassword2').val(), $('#inputEmail2').val()).toString() }))
              }
              localStorage.setItem('remail', $('#inputEmail2').val())
              window.location = localUrl + '/emailValidation'
            }
            else if (data.msg == "User Exists") {
              $('#rerror').html("<p class='text-danger'>Email already registered</p>")
            }
          })
        })
      })
      $("#loginForm").submit(function (e) {
        e.preventDefault()
        let actualPassword = $('#inputPassword1').val()
        let data = {
          email: $('#inputEmail1').val(),
          password: generateHash($('#inputPassword1').val())
        }
        let copy = fetchOptions
        copy.body = JSON.stringify(data)
        fetch(url + "/signin", copy).then(
          function (response) {
            if (response.status !== 200) {
              $("#error").html("<p class='text-danger'>Invalid Credentials</p>")
              console.log('Something wrong Response Status: ' + response.status)
              return
            }
            // Examine the text in the response
            response.json().then(function (data) {
              console.log(data)
              if (data.msg == 'Unverified') {
                $("#error").html("<p class='text-danger'>Verify user before login</p>")
                return
              }
              localStorage.setItem('token', data.token)
              localStorage.setItem('password', actualPassword)
              window.location = '/dashboard'
            })
          }
        )

      })
      $('#exampleFormControlFile1').change(function (e) {
        //console.log(e.target.files[0])
        let file = e.target.files[0],
          reader = new FileReader()
        reader.onload = function (evt) {
          //console.log(evt.target.result)
          let json = JSON.parse(evt.target.result)
          if (json.cipher) {
            let key = $('#inputEmail3').val()
            //console.log(json.cipher)
            //console.log(CryptoJS.AES.decrypt(json.cipher, key).toString(CryptoJS.enc.Utf8))
            $('#staticPassword').val(CryptoJS.AES.decrypt(json.cipher, key).toString(CryptoJS.enc.Utf8))
          }
        }
        reader.readAsText(file)
      })

    })
  </script>
  <!--Validation Scripts-->
  <script type="text/javascript">
    let confirm = document.getElementById("inputConfirmPassword2"), password = document.getElementById("inputPassword2")
    function customValidity() {
      if (password.value != confirm.value) {
        confirm.setCustomValidity("Passwords don't match")
      }
      else {
        confirm.setCustomValidity("");
      }
    }
    password.onchange = customValidity
    confirm.onkeyup = customValidity
  </script>
  <!--Validation Scripts-->
</body>

</html>